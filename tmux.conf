# ============================================================================
# tmux Configuration
# AI Coding Agent に最適化された設定
# ============================================================================

# ----------------------------------------------------------------------------
# 基本設定
# ----------------------------------------------------------------------------

# Prefix キーを Ctrl-t に変更（screen と統一）
set -g prefix C-t
unbind C-b
bind C-t send-prefix

# 設定再読み込み: Prefix + r
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# ウィンドウとペインのインデックスを1から開始
set -g base-index 1
setw -g pane-base-index 1

# ウィンドウ番号を自動で詰める
set -g renumber-windows on

# ----------------------------------------------------------------------------
# スクロールバック設定
# ----------------------------------------------------------------------------

# スクロールバックバッファを10000行に設定（AI出力確認用に大きめ）
set -g history-limit 10000

# ----------------------------------------------------------------------------
# カラー・表示設定
# ----------------------------------------------------------------------------

# True Color (24bit) サポート
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# アクティブ/非アクティブペインの表示
set -g window-style 'bg=colour235'
set -g window-active-style 'bg=colour0'

# ----------------------------------------------------------------------------
# マウスサポート
# ----------------------------------------------------------------------------

# マウスを有効化（ペイン切り替え、スクロール）
set -g mouse on

# ----------------------------------------------------------------------------
# ステータスバー設定
# ----------------------------------------------------------------------------

# ステータスバーを上部に配置（お好みで bottom に変更可能）
set -g status-position bottom

# ステータスバーの更新間隔
set -g status-interval 1

# ステータスバーの色設定
set -g status-style 'bg=colour234 fg=colour137'

# 左側: セッション名
set -g status-left-length 40
set -g status-left '#[fg=colour233,bg=colour245,bold] #S #[fg=colour245,bg=colour234,nobold]'

# 右側: 日時
set -g status-right-length 60
set -g status-right '#[fg=colour245]#(whoami)@#H #[fg=colour233,bg=colour241,bold] %Y-%m-%d #[fg=colour233,bg=colour245,bold] %H:%M:%S '

# ウィンドウのフォーマット
setw -g window-status-format '#[fg=colour250,bg=colour234] #I:#W '
setw -g window-status-current-format '#[fg=colour233,bg=colour39,bold] #I:#W '

# メッセージの色
set -g message-style 'bg=colour166 fg=colour232 bold'

# ----------------------------------------------------------------------------
# ペイン操作
# ----------------------------------------------------------------------------

# ペイン分割（現在のディレクトリを維持）
# 縦分割: Prefix + |
bind | split-window -h -c "#{pane_current_path}"
# 横分割: Prefix + -
bind - split-window -v -c "#{pane_current_path}"

# デフォルトの分割キーバインドも維持
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# ペインサイズ変更（Prefix + H/J/K/L で大きく変更）
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# ペインサイズ変更（Prefix + h/j/k/l で小さく変更）
bind -r C-h resize-pane -L
bind -r C-j resize-pane -D
bind -r C-k resize-pane -U
bind -r C-l resize-pane -R

# ----------------------------------------------------------------------------
# Vim風キーバインド
# ----------------------------------------------------------------------------

# Vim キーバインドを使用
setw -g mode-keys vi

# ペイン移動（Prefix + h/j/k/l）
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Alt + 矢印キーでもペイン移動（Prefix なし）
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# ----------------------------------------------------------------------------
# コピーモード設定（Vim風）
# ----------------------------------------------------------------------------

# コピーモードに入る: Prefix + [
# v で選択開始
bind -T copy-mode-vi v send-keys -X begin-selection
# y でコピー
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
# 矩形選択: Ctrl + v
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# macOS のクリップボードと連携
if-shell "uname | grep -q Darwin" {
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
    bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"
}

# Linux のクリップボードと連携 (xclip)
if-shell "uname | grep -q Linux" {
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -selection clipboard"
    bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "xclip -selection clipboard"
}

# ----------------------------------------------------------------------------
# ウィンドウ操作
# ----------------------------------------------------------------------------

# 新しいウィンドウ（現在のディレクトリを維持）
bind c new-window -c "#{pane_current_path}"

# ウィンドウ移動
bind -r C-p previous-window
bind -r C-n next-window

# ウィンドウ入れ替え
bind -r < swap-window -t -1\; select-window -t -1
bind -r > swap-window -t +1\; select-window -t +1

# ----------------------------------------------------------------------------
# セッション管理
# ----------------------------------------------------------------------------

# セッション切り替え
bind s choose-tree -Zs

# 新規セッション
bind S new-session

# セッション終了
bind X confirm-before -p "Kill session #S? (y/n)" kill-session

# ----------------------------------------------------------------------------
# その他の便利な設定
# ----------------------------------------------------------------------------

# エスケープキーの遅延をなくす（Vim 等で快適に）
set -sg escape-time 0

# キーリピートのタイムアウト
set -g repeat-time 600

# フォーカスイベントを有効化（Vim の autoread 等で使用）
set -g focus-events on

# ペインの境界線
set -g pane-border-style 'fg=colour238'
set -g pane-active-border-style 'fg=colour39'

# ベルを無効化
set -g bell-action none
set -g visual-bell off

# タイトルを設定
set -g set-titles on
set -g set-titles-string '#S - #W'

# ----------------------------------------------------------------------------
# ペイン同期（複数サーバーへの一括操作など）
# ----------------------------------------------------------------------------

# Prefix + e で全ペインに同時入力をトグル
bind e setw synchronize-panes \; display-message "Synchronize panes: #{?pane_synchronized,ON,OFF}"
